<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Wargames 5 - COMP6447 Musings</title><meta name=renderer content=webkit><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=theme-color content=#f8f5ec><meta name=msapplication-navbutton-color content=#f8f5ec><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#f8f5ec><meta name=author content=z5206677><meta name=description content="Shellcrack [Binary]"><meta name=keywords content=Hugo,theme,even><meta name=generator content="Hugo 0.58.2 with theme even"><link rel=canonical href=../../../post/wargames/war5/><link rel=apple-touch-icon sizes=180x180 href=../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../favicon-16x16.png><link rel=manifest href=../../../manifest.json><link rel=mask-icon href=../../../safari-pinned-tab.svg color=#5bbad5><link href=../../../dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><link rel=stylesheet href=../../../css/typedjs.shortcode.css><meta property=og:title content="Wargames 5"><meta property=og:description content="Shellcrack [Binary]"><meta property=og:type content=article><meta property=og:url content=/post/wargames/war5/><meta property=article:published_time content=2020-07-12T12:00:00+10:00><meta property=article:modified_time content=2020-07-12T12:00:00+10:00><meta itemprop=name content="Wargames 5"><meta itemprop=description content="Shellcrack [Binary]"><meta itemprop=datePublished content=2020-07-12T12:00:00&#43;10:00><meta itemprop=dateModified content=2020-07-12T12:00:00&#43;10:00><meta itemprop=wordCount content=718><meta itemprop=keywords content><meta name=twitter:card content=summary><meta name=twitter:title content="Wargames 5"><meta name=twitter:description content="Shellcrack [Binary]"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=../../../ class=logo>COMP6447 Musings</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=../../../><li class=mobile-menu-item>Home</li></a><a href=https://github.com/featherbear/UNSW-COMP6447><li class=mobile-menu-item>GitHub</li></a><a href=../../../categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=../../../ class=logo>COMP6447 Musings</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=../../../>Home</a></li><li class=menu-item><a class=menu-item-link href=https://github.com/featherbear/UNSW-COMP6447>GitHub</a></li><li class=menu-item><a class=menu-item-link href=../../../categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Wargames 5</h1><div class=post-meta><span class=post-time>2020-07-12</span><div class=post-category><a href=../../../categories/wargames/>Wargames</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#shellcrack>Shellcrack</a><ul><li><a href=#scenario>Scenario</a></li><li><a href=#solution>Solution</a></li></ul></li><li><a href=#stack-dump-2>Stack Dump 2</a><ul><li><a href=#scenario-1>Scenario</a></li><li><a href=#solution-1>Solution</a></li></ul></li><li><a href=#image-viewer>Image Viewer</a><ul><li><a href=#scenario-2>Scenario</a></li><li><a href=#solution-2>Solution</a></li></ul></li><li><a href=#source-code-audit>Source Code Audit</a></li><li><a href=#reversing-challenge>Reversing Challenge</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=shellcrack>Shellcrack</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/shellcrack>Binary</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/solve-shellcrack.py>Solution</a>]</p><h3 id=scenario>Scenario</h3><p>There is an 8 byte long canary (generated from /dev/urandom) stored at ebp-0x14.<br>Input is read into a buffer at ebp-0x44 to ebp-0x34, which is copied to ebp-0x24 to ebp-0x14.<br>A vulnerability with the &quot;%s&quot; format specifier exists which allows the canary to be read from</p><h3 id=solution>Solution</h3><p>Send a name that is 16 bytes long, such as to remove the NULL terminator from the string.<br>This will cause the program to print out the canary after the name.<br>We can then perform a buffer overflow, and shellcode into the buffer whilst keeping the canary value correct.</p><hr><h2 id=stack-dump-2>Stack Dump 2</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/stack-dump2>Binary</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/solve-stack-dump2.py>Solution</a>]</p><h3 id=scenario-1>Scenario</h3><p>Similar to the week 3 stack-dump exercise, however this time with all protections enabled.<br>We will need to leak the canary (input -&gt; dump) in order to successfully override the return address of main</p><h3 id=solution-1>Solution</h3><p>An address on the stack is given, which we can use to calculate the address of the canary. By then using the memory map, we can figure out where the win function address has been relocated to.<br>With the canary value and the win address, we can perform a buffer overflow at ebp-0x68.</p><hr><h2 id=image-viewer>Image Viewer</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/image-viewer>Binary</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/image-viewer.c>Source</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/solve-image-viewer.py>Solution</a>]</p><h3 id=scenario-2>Scenario</h3><p>A flag supposedly exists in the file &quot;flat earth truth&quot;, however there is censorship &gt;:(. If the image ID corresponding to the flag file is entered, the program terminates early.</p><p>We need a way to bypass the filename check.<br>The <code>buf</code> address is immediately adjacent to the <code>images</code> variable, and the atoi function could be exploitable...</p><h3 id=solution-2>Solution</h3><p>The program reuses the <code>buf</code> buffer (128 bytes) for both the password and ID input. The <code>atoi</code> takes in a string and parses however many characters as it can, as an integers. We can exploit this functionality by entering a number, but taking control of the rest of the buffer with our own input data.</p><p>As the memory for <code>buf</code> and <code>images</code> are next to each other, we can make <code>atoi</code> return a negative number, which would be used as a negative index of <code>images</code> - hence accessing <code>buf</code> as an image struct.</p><p>Our image structure needs to contain an ID and a pointer to a filename string. For the ID, we use <code>-2</code>, rather than <code>-1</code> due to the nature of <code>fgets</code> replacing the last character with a <code>\0</code>. The filename string can reside inside the buffer as well, in a different memory location.</p><p>To bypass the <code>strcmp</code> function, we can prepend a <code>./</code> to the flag file, resulting in <code>./flat earth truth</code>. Leaking the contents of this file reveals that the flag is actually located in the <code>/flag</code> file.</p><p>The password check is trivial.</p><hr><h2 id=source-code-audit>Source Code Audit</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/source.c>Source</a>]</p><ul><li>Directory traversal vulnerability - arbitrary write to any file<ul><li>Location: <code>source.c:71</code></li><li>Example: <code>action = &quot;../../../../../../../../../../../../../etc/passwd&quot;</code></li></ul></li><li>Directory traversal vulnerability - arbitrary read of any file<ul><li>Location: <code>source.c:97</code></li><li>Example: <code>action = &quot;../../../../../../../../../../../../../etc/passwd&quot;</code></li></ul></li><li>Race condition - possible corruption of result data<ul><li>Location: <code>source.c:116-118</code></li><li>Example: Two simultaneous <code>list_files</code> calls may both attempt to read/write from <code>list.txt</code></li></ul></li><li>SET_PERMISSION_LEVEL - Incorrect check logic<ul><li>Location: <code>source.c:171</code></li><li><code>admin_level</code> by default is set to <code>0</code> - allowing any user to perform RCE</li></ul></li><li>SET_PERMISSION_LEVEL - <code>level</code> not scanned properly<ul><li>Location: <code>source.c:160</code></li><li>Fix: <code>sscanf(action + 1, &quot;%d&quot;, &amp;level)</code></li><li>Also, the level is reset with every new command???</li></ul></li><li>SET_PERMISSION_LEVEL - Implicit type cast<ul><li>Location: <code>source.c:167</code></li><li><code>admin_level</code> is of type <code>uint8_t</code>, whilst <code>level</code> is of type <code>int</code></li><li>An input of 256 will skip the <code>level == 0</code> check, but will result in <code>0</code> when casted to an 8-bit value, granting the user administrative privilege</li></ul></li></ul><hr><h2 id=reversing-challenge>Reversing Challenge</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/chal.jpg>Disassembly</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week5/chall.c>Solution</a>]</p><p>The assembly code contains a function that returns a value.<br><code>0x2aaaaaaab</code> appears to be a rounded value of <code>2**32 // 6</code>, which appears to be a signed integer division by 6.</p><p>Two arguments, <code>arg1</code> and <code>arg2</code> are added together as a sum, and are worked on.</p><p>The final return value appears to be <code>arg1 + arg2 - 6 * [ HI((arg1+arg2) * 0x2aaaaaaab) - (arithmetic (arg+arg2) &gt;&gt; by 0x1f (31)) ]</code></p><p>In simplification, we reach the expression <code>sum - (sum / 6 * 6)</code></p><ul><li><code>sum/6</code> =&gt; number of times 6 fits in the sum</li><li><code>(sum/6) * 6</code> =&gt; quotient * 6 =&gt; highest multiple of 6 in the sum</li><li><code>sum - sum/6*6</code> =&gt; remainder when dividing by 6</li></ul><p>This finally simplifies to the <code>mod 6</code> operation.</p></div><footer class=post-footer><nav class=post-nav><a class=prev href=../../../post/midsem/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Midsem Exam</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=../../../post/return-oriented-programming/><span class="next-text nav-default">Return Oriented Programming</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:z5206677@student.unsw.edu.au class="iconfont icon-email" title=email></a><a href=https://www.linkedin.com/in/andrewjinmengwong/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/featherbear class="iconfont icon-github" title=github></a><a href=https://www.instagram.com/_andrewjwong/ class="iconfont icon-instagram" title=instagram></a><a href=../../../index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Andrew Wong (z5206677)</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=../../../dist/even.26188efa.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-107434487-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=../../../js/typed.js@2.0.9></script><script src=../../../js/typedjs.shortcode.js></script></body></html>