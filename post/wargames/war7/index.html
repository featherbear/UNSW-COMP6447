<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Wargames 7 - COMP6447 Musings</title><meta name=renderer content=webkit><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=theme-color content=#f8f5ec><meta name=msapplication-navbutton-color content=#f8f5ec><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#f8f5ec><meta name=author content=z5206677><meta name=description content="usemedontabuseme [Binary]"><meta name=keywords content=Hugo,theme,even><meta name=generator content="Hugo 0.58.2 with theme even"><link rel=canonical href=../../../post/wargames/war7/><link rel=apple-touch-icon sizes=180x180 href=../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../favicon-16x16.png><link rel=manifest href=../../../manifest.json><link rel=mask-icon href=../../../safari-pinned-tab.svg color=#5bbad5><link href=../../../dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><link rel=stylesheet href=../../../css/typedjs.shortcode.css><meta property=og:title content="Wargames 7"><meta property=og:description content="usemedontabuseme [Binary]"><meta property=og:type content=article><meta property=og:url content=/post/wargames/war7/><meta property=article:published_time content=2020-07-22T12:00:00+10:00><meta property=article:modified_time content=2020-07-22T12:00:00+10:00><meta itemprop=name content="Wargames 7"><meta itemprop=description content="usemedontabuseme [Binary]"><meta itemprop=datePublished content=2020-07-22T12:00:00&#43;10:00><meta itemprop=dateModified content=2020-07-22T12:00:00&#43;10:00><meta itemprop=wordCount content=691><meta itemprop=keywords content><meta name=twitter:card content=summary><meta name=twitter:title content="Wargames 7"><meta name=twitter:description content="usemedontabuseme [Binary]"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=../../../ class=logo>COMP6447 Musings</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=../../../><li class=mobile-menu-item>Home</li></a><a href=https://github.com/featherbear/UNSW-COMP6447><li class=mobile-menu-item>GitHub</li></a><a href=../../../categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=../../../ class=logo>COMP6447 Musings</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=../../../>Home</a></li><li class=menu-item><a class=menu-item-link href=https://github.com/featherbear/UNSW-COMP6447>GitHub</a></li><li class=menu-item><a class=menu-item-link href=../../../categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Wargames 7</h1><div class=post-meta><span class=post-time>2020-07-22</span><div class=post-category><a href=../../../categories/wargames/>Wargames</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#usemedontabuseme>usemedontabuseme</a><ul><li><a href=#scenario>Scenario</a></li><li><a href=#solution>Solution</a></li></ul></li><li><a href=#ezpz1>ezpz1</a><ul><li><a href=#scenario-1>Scenario</a></li><li><a href=#solution-1>Solution</a></li></ul></li><li><a href=#ezpz2>ezpz2</a><ul><li><a href=#scenario-2>Scenario</a></li><li><a href=#solution-2>Solution</a></li></ul></li><li><a href=#ezpz2-1>ezpz2</a><ul><li><a href=#scenario-3>Scenario</a></li><li><a href=#solution-3>Solution</a></li></ul></li><li><a href=#notezpz>notezpz</a><ul><li><a href=#scenario-4>Scenario</a></li><li><a href=#solution-4>Solution</a></li></ul></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=usemedontabuseme>usemedontabuseme</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/usemedontabuseme>Binary</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/solve-usemedontabuseme.py>Solution</a>]</p><h3 id=scenario>Scenario</h3><p>Functions are given that allow us to create, rename and delete a certain of each allocated memory structure. We need to leverage the fact that chunk metadata and content are stored in the same location.</p><h3 id=solution>Solution</h3><p>We are able to view the name of a killed clone. Due to the way free chunks are stored, the pointer of the next free chunk is stored in the same location as the name. This allows us to override the location of the second-next chunk location.</p><p>By allocating a chunk (A), then allocating a chunk (B) that starts <code>0xc</code> bytes after (A), we can modify the function pointer. By using the Give Hint functionality, the modified function pointer will be executed</p><hr><h2 id=ezpz1>ezpz1</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/ezpz1>Binary</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/solve-ezpz1.py>Solution</a>]</p><h3 id=scenario-1>Scenario</h3><p>The program performs two malloc calls for each question creation.<br>When freed, if they are not cleared - their contents can be accessed.<br>The order of freeing is also important, as the last freed item becomes the head of the free list.</p><h3 id=solution-1>Solution</h3><p>When creating and freeing a question, the two allocated chunks are freed in the wrong order.<br>By still having access to previous container chunk, we can set the contents of a new question - which will actually modify the previous container chunk.</p><hr><h2 id=ezpz2>ezpz2</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/ezpz2>Binary</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/solve-ezpz2.py>Solution</a>]</p><h3 id=scenario-2>Scenario</h3><p>Compared to ezpz1, ezpz2 frees the two chunks for each question in the right order.<br>However, the <code>fgets</code> function in <code>set_question</code> is vulnerable to a buffer overlfow.</p><h3 id=solution-2>Solution</h3><p>By performing a buffer/heap overflow, we are able to control the contents chunks of adjacent questions.<br>This allows us to modify the address of those questions&rsquo; buffers.<br>We can leak the address of the libc calls from the GOT table by overwriting the buffer location to the GOT table entry.<br>By leaking several addresses, we can find the correct libc version - to then calculate the correct offset for the <code>system</code> call.<br>The <code>free</code> address of the GOT can be overridden to the <code>system</code> call, to gain access to the shell.</p><hr><h2 id=ezpz2-1>ezpz2</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/ezpz2>Binary</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/solve-ezpz2.py>Solution</a>]</p><h3 id=scenario-3>Scenario</h3><p>Compared to ezpz1, ezpz2 frees the two chunks for each question in the right order.<br>However, the <code>fgets</code> function in <code>set_question</code> is vulnerable to a buffer overlfow.</p><h3 id=solution-3>Solution</h3><p>By performing a buffer/heap overflow, we are able to control the contents chunks of adjacent questions.<br>This allows us to modify the address of those questions&rsquo; buffers.<br>We can leak the address of the libc calls from the GOT table by overwriting the buffer location to the GOT table entry.<br>By leaking several addresses, we can find the correct libc version - to then calculate the correct offset for the <code>system</code> call.<br>The <code>free</code> address of the GOT can be overridden to the <code>system</code> call, to gain access to the shell.</p><hr><h2 id=notezpz>notezpz</h2><p>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/notezpz>Binary</a>]<br>[<a href=https://github.com/featherbear/UNSW-COMP6447/raw/master/wargames/week8/solve-notezpz.py>Solution</a>]</p><h3 id=scenario-4>Scenario</h3><p>The GOT table is Read-Only, NX is enabled, and PIE is enabled.<br>Unlike ezpz2, we won&rsquo;t be able to overwrite the GOT for <code>free</code>.<br>However, libc offers a <code>__free_hook</code> :hm:</p><h3 id=solution-4>Solution</h3><p>In order to set the <code>__free_hook</code>, we need to know the base address of libc - for example through the GOT.<br>However to get the address of the GOT (due to PIE), we need to leak the program base address.<br>The allocated memory in the heap contains a function pointer to <code>print_question</code> - something inside the program memory. However to get that, we need to leak the address of the heap first.</p><p>So&hellip;</p><p>Firstly, by performing a double free - we can leak the container address of a given question.<br>We can then overwrite the address that <code>malloc</code> will return - allowing us to control where we read/write data from/to. By changing the buffer address to the container address, we can leak the address of <code>print_question</code>.</p><p>We can then calculate the program base through <code>print_question</code>&rsquo;s offset.<br>After that, we can leak addresses from the GOT, and use that to calculate the libc base.</p><p>With the libc base known, we can write the address of <code>system</code> into <code>__free_hook</code>.<br>After writing <code>&quot;/bin/sh\0&quot;</code> back into the actual buffer, and resetting the buffer location to there; by calling the <code>delete_question</code> function - <code>free(*(eax + 0x18))</code> will be called, which will spawn a shell.</p></div><footer class=post-footer><nav class=post-nav><a class=prev href=../../../post/heap-overflow/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Heap Overflow</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=../../../post/tutorials/tutorial8/><span class="next-text nav-default">Tutorial 8</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:z5206677@student.unsw.edu.au class="iconfont icon-email" title=email></a><a href=https://www.linkedin.com/in/andrewjinmengwong/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/featherbear class="iconfont icon-github" title=github></a><a href=https://www.instagram.com/_andrewjwong/ class="iconfont icon-instagram" title=instagram></a><a href=../../../index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Andrew Wong (z5206677)</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=../../../dist/even.26188efa.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-107434487-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=../../../js/typed.js@2.0.9></script><script src=../../../js/typedjs.shortcode.js></script></body></html>